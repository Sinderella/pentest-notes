# Chapter 3: Internet Host and Network Enumeration

## Reconnaissance process

1. Querying Web and Newsgroup Search Engines
- Google Hack (allintitle, site)
- Newsgroups (http://groups.google.com)
- Netcraft
2. WHOIS, linux has `whois`
3. BGP
4. DNS
5. Web Server Crawling
6. SMTP Probing

### DNS

Reverse DNS Sweeping
- `ghba $IP_BLOCK`
- `nmap -sL $IP_BLOCK`

### Web Server Crawling

Crawling and Spidering
- Wikto
- Nikto
- HTTrack
- BlackWidow
- GNU Wget

### Automating Enumeration

.NET and C#
- SpiderFoot
- BiDiBLAH

### SMTP Probing

Sending to a non-existing account to reveal information

# Chapter 4: IP Network Scanning

## ICMP Probing

### Types

Type 8: echo request
Type 13: timestamp request
Type 15: information request
- support self-configuring systems, diskless at boot time to discover their network addresses, using protocols like RARP BOOTP DHCP (rarely used)
Type 17: subnet address mask request
- reveals subnet mask used by the target host, useful for mapping networks and identifying the size of subnets

Type 11 Code 0: routing loop
Type 3 Code 13: ICMP administratively prohibited -> an ACL in use on a router or firewall 

### Tools

#### Send ICMP Nasty Garbage (SING)

`sing -echo $IP`
`sing -tstamp $IP`
`sing -mask $IP`

#### Nmap

Ping sweep may not effective in some cases, hardened networks will blanket-filter inboud ICMP mesages at border routers or firewall.

`nmap -sP -PI $IP` # also sends TCP ACK and SYN to port 80

#### ICMPScan

Support type: 8, 13, 15, 17
Derived from Nmap
Has promiscuous mode (-c), for unsolicited responses

`icmpscan -c -t 500 -r 1 $IP`

## Identifying Subnet Network and Broadcast Addresses

`nmap -sP $IP_BLOCK` returns allocated IP addresses with its domain

## Gleaning Internal IP Addresses

Firewalls often use Network Address Translation (NAT) or similar to forward the packets on to internal addresses.

Poor routing configuration router responds with different interface.

ISS BlackICE and ICMPScan in promiscuous mode can detect this.

Ethereal or tcpdump to pick up unsolicited ICMP responses.

## OS Fingerprinting Using ICMP

Xprobe2 - `xprobe2 -v $IP`

## TCP Port Scanning

9 types of TCP port scanning

Standard scanning methods
- vanilla connect() scanning
- half-open SYN flag scanning

Stealth TCP scanning methods
- inverse TCP flag scanning
- ACK flag probe scanning
- TCP fragmentation scanning

Third-party and spoofed TCP scanning methods
- FTP bounce scanning
- proxy bounce scanning
- sniffer-based spoofed scanning
- IP ID header scanning

### Standard Scanning Methods

reliable, but easily loggied and identified

simple direct techniques used to accurately identify accessible TCP ports and services.

#### Vanilla connect() Scanning

Good
- reliable
- not require superuser root access as raw network sockets are not used

Bad
- not stealthy
- full TCP/IP connection is established
- full three-way handshake is performed, an aggressive connect() scan could antagonise or break network services

Nmap -sT flag

#### Half-open SYN flag Scanning

third part of three-way handshake is RST packet to reset the TCP connection

Good
- not logged
- speed, connection is not established
- efficiency

Bad
- not stealthy, most IDS detect this

Nmap -sS flag, -T (timing policy) to avoid packets being dropped
Unicornscan -> fast
Scanrand -> fast
Foundstone's SuperScan, windows tool

### Stealth TCP Scanning Methods

not accurate for some OS, but stealth

take advantage of idiosyncrasies in certain TCP/IP stack implementations

#### Inverse TCP flag Scanning

Sned probe packets with different TCP flags set, using malfored TCP flags to probe a target is known as an inverted technique -> respond only if the port is closed

3 types of probe packet flag
- FIN probe with the FIN TCP flag
- XMAS probe with FIN, URG, and PUSH TCP flags
- NULL probe with no TCP flags

Good
- stealthy

Bad
- not accurate
- some OS (windows) disregard RFC 793 and does not respond with RST/ACT -> only affect some Unix-based platform

Nmap -sF (FIN), -sX (XMAS), -sN (NULL)
Vscan, windows tool, does not require WinPcap, uses Winsock 2 (windows lib)

#### ACK flag probe scanning

analyses header of RST packets
affects BSD-derived TCP/IP stack

Good
- hard to detect

Bad
- relies on TCP/IP stack implementation bugs in BSD-derived systems, but not in many modern platforms

Nmap -sA (TTL), -sW (WINDOW)
hping2, time consuming, useful for analysing low-level responses

###### Analysis of the time-to-live (TTL)

Tool firewalk

sends thousands of crafted ACK to TCP ports
values of TTL are different from others if the ports are open, less than TTL boundary (64)

###### Analysis of the WINDOW field

sends thousands of crafted ACK to TCP ports
values of WINDOW are different from others if the ports are open, nonzero

### Third-Party and Spoofed TCP Scanning Methods

port scanning bounced through vulnerable servers to hide source of the scanning

#### FTP bounce scanning

PORT command allows data to be sent to user-specified hosts and ports

1. attacker connects to FTP and use PORT command to attempt a connection to a specific port `PORT 144,51,17,240,0,23` (144.51.17.240:23)
2. LIST command to create the connection, response with 226 status code -> open, 425 -> close

`nmap -P0 -b $user:$passwd@$server:$port $target`
-P0 suppress pinging

#### Proxy bounce scanning



# Acronyms

ICMP - Ineternet Control Message Protocol
RIRs - Regional Internet Registries
NAT - Network Address Translation
SING - Send ICMP Nasty Garbage
ACL - Access Control List
